<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut Icon" type="image/x-icon" href="">
    <link rel="icon" type="image/png" sizes="16x16" href="">
    <link rel="icon" type="image/png" sizes="32x32" href="">
    <link rel="icon" type="image/png" sizes="96x96" href="">

    <title></title>

    <!-- core -->
    <script src="/static/core/jquery-3.5.1/jquery-3.5.1.min.js"></script>
    <link href="/static/core/bootstrap-5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <script src="/static/core/bootstrap-5.1.3/js/bootstrap.bundle.min.js"></script>

    <!-- plugins -->
    <script src="/static/plugins/vue-3.2.45/vue.global.min.js"></script>
    <link href="/static/plugins/fontawesome-free-5.15.1-web/css/all.min.css" rel="stylesheet">

    <!-- main -->
    <link href="/static/common/css/main.css" rel="stylesheet">
    <script src="/static/common/js/main.js"></script>
</head>
<body>
    <div id="wrap">
        <main id="main" class="animate" :style="`background: ${data.background}`">
            <div class="container py-3">
                <div class="text-center" style="height: var(--img-height);">
                    <img class="mb-3 h-100" :src="data.banner || ''" style="object-fit: contain;">
                </div>
                <div class="text-start ch-gx-2">
                    <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvas-settings"><i class="fa fa-cog me-2"></i>設定</button>
                    <button class="btn btn-danger" type="button" :disabled="!dataReady || isDraw" @click="startDraw()"><i class="fa fa-crown me-2"></i>抽獎</button>
                </div>

                <hr>

                <div class="row g-3">
                    <div class="col-lg-7 ch-gy-3">
                        <div v-for="(item, idx) of data.prizes.data">
                            <h4>{{item.name}} (抽出:{{item.amount}}個) (得獎:{{item.winners.length}}人)</h4>
                            <div class="card">
                                <div class="card-body" style="max-height: 250px; overflow: auto;">
                                    <div v-if="!item.winners[0]" class="text-danger">尚未開獎</div>
                                    <div v-for="(winner, idx) of item.winners" class="slideUpAni" :style="`animation-delay: ${idx / item.winners.length}s;`"><b>{{winner}}</b></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="ch-gy-3" style="position: sticky; top: 0;">
                            <div>
                                <h4>未抽中名單：(共{{data.drawListDraw.lose.data.length}}名)</h4>
                                <textarea class="form-control result_textarea" v-model="data.drawListDraw.lose.text" disabled></textarea>
                            </div>
                            <div>
                                <h4 class="flex-center-a">輸出資料：<button class="btn btn-danger btn-sm" @click="remove_outputText()">清除</button></h4>
                                <textarea class="form-control result_textarea" v-model="data.drawListDraw.outputText" disabled></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div class="offcanvas offcanvas-start offcanvas-md" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="offcanvas-settings">
            <div class="offcanvas-header">
                <h4 class="offcanvas-title flex-center-a">
                    <div>抽獎設定 </div>
                    <div class="ms-2 ch-gx-2">
                        <button v-if="data_LS" class="btn btn-secondary btn-sm" :disabled="dataReady" @click="loadLS()"><i class="fa fa-file-code me-2"></i>讀取設定</button>
                        <button v-if="dataReady" class="btn btn-dark btn-sm" @click="toEditMode()"><i class="fa fa-edit me-2"></i>重啟編輯</button>
                    </div>
                </h4>
                <button type="button" class="btn btn-close" data-bs-dismiss="offcanvas"></button>
            </div>
            <div class="offcanvas-body">
                <div class="ch-gy-3 h-100 overflow-auto" style="display: flex; flex-direction: column;">
                    <div class="">
                        <h5 class="flex-center-a">
                            <div><i class="far fa-image text-warning me-2"></i>抽獎圖片：</div>
                            <div v-if="data.bannerSize > 2"><i class="fa fa-exclamation-triangle text-danger" title="檔案已超過2MB，可能會無法暫存數據。"></i></div>
                        </h5>
                        <input type="file" id="fileInput" class="form-control" @change="fileOnChange()" accept="image/*" :disabled="dataReady">
                    </div>
                    <div class="">
                        <h5 class="flex-center-a">
                            <div><i class="fa fa-paint-roller text-danger me-2"></i>背景色：</div>
                        </h5>
                        <input type="color" class="form-control" style="height: 38px;" v-model="data.background" :disabled="dataReady">
                    </div>

                    <!-- <div class="">
                        <h5><i class="far fa-image text-warning me-2"></i>抽獎主題：</h5>
                        <input id="title" type="text" class="form-control" v-model="title">
                    </div> -->
                    <div class="flex-grow-1 flex-shrink-0">
                        <h5 class="flex-center-a">
                            <div><i class="fas fa-gift text-success me-2"></i>獎項設定：</div>
                            <div class="flex-center-a ch-gx-2">
                                <div class="dropdown">
                                    <button type="button" class="btn btn-primary btn-sm dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" :disabled="dataReady">快速產生</button>
                                    <ul class="dropdown-menu">
                                        <li><button class="dropdown-item" @click="genPrizes(3)" :disabled="dataReady">產3獎 (14抽)</button></li>
                                        <li><button class="dropdown-item" @click="genPrizes(6)" :disabled="dataReady">產6獎 (91抽)</button></li>
                                        <li><button class="dropdown-item" @click="genPrizes(10)" :disabled="dataReady">產10獎 (385抽)</button></li>
                                        <li><button class="dropdown-item" @click="genPrizes(25)" :disabled="dataReady">產25獎 (5525抽)</button></li>
                                        <li><button class="dropdown-item" @click="genPrizes(50)" :disabled="dataReady">產50獎 (42925抽)</button></li>
                                    </ul>
                                </div>
                                <button class="btn btn-success btn-sm" @click="prizes_reverse()" :disabled="dataReady"><i class="fas fa-sort me-2"></i>反轉資料</button>
                            </div>
                        </h5>
                        <textarea id="settings" class="form-control offcanvas_textarea" v-model="data.prizes.text" :disabled="dataReady" @input="data.prizes.data = updatePrizes_text2data()"></textarea>
                        <div class="text-end">獎項{{data.prizes.data.length}}種，共{{prizes_amount}}抽</div>
                    </div>
                    <div class="flex-grow-1 flex-shrink-0">
                        <h5 class="flex-center-a">
                            <div><i class="fas fa-users text-primary me-2"></i>待抽名單：</div>
                            <div class="flex-center-a ch-gx-2">
                                <div class="dropdown">
                                    <button type="button" class="btn btn-primary btn-sm dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" :disabled="dataReady">快速產生</button>
                                    <ul class="dropdown-menu">
                                        <li><button class="dropdown-item" @click="genDrawList(10)" :disabled="dataReady">產10名</button></li>
                                        <li><button class="dropdown-item" @click="genDrawList(100)" :disabled="dataReady">產100名</button></li>
                                        <li><button class="dropdown-item" @click="genDrawList(1000)" :disabled="dataReady">產1,000名</button></li>
                                        <li><button class="dropdown-item" @click="genDrawList(10000)" :disabled="dataReady">產10,000名</button></li>
                                        <li><div class="dropdown-item flex-center-a ch-gx-2 py-0">
                                            <input class="form-control form-control-sm" maxlength="99" v-model.number="genDrawListValue">
                                            <button class="btn btn-primary btn-sm flex-shrink-0" @click="genDrawList( genDrawListValue )">產生</button>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </h5>
                        <textarea class="form-control offcanvas_textarea" v-model="data.drawList.text" :disabled="dataReady" @input="data.drawList.data = updateDrawList_text2data( data.drawList )"></textarea>
                        <div class="text-end">共{{data.drawList.data.length}}名</div>
                    </div>
                    <div class="flex-center-a justify-content-between">
                        <div>
                            <button class="btn btn-success" :disabled="dataReady" @click="saveToLS()"><i class="fa fa-save me-2"></i>暫存設定</button>
                        </div>
                        <div class="ch-gx-2">
                            <button class="btn btn-danger" :disabled="dataReady" @click="readyToDraw()"><i class="fa fa-gifts me-2"></i>準備抽獎</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { ref, reactive, computed, watch } = Vue;
        const app = Vue.createApp({
            setup(){
                const dataReady = ref(false);
                const isDraw = ref(false);
                const data_LS = ref( localStorage.getItem('lotteryData') );
                const genDrawListValue = ref(0);
                const data = reactive({
                    background: '#ffffff',
                    banner: '',
                    bannerSize: 0,
                    title: '',
                    prizes: { // 設定獎項
                        data: [{name: '一等獎', amount: '10', winners: []},], // [ {name: '一等獎', amount: '10', winners: []}, ... ]
                        text: '一等獎,10', // '一等獎,10\n...'
                    },
                    drawList: { // 設定好的原始資料
                        data: ['Andy 台北市','Ben 20歲'],
                        text: 'Andy 台北市\nBen 20歲',
                    },
                    drawListDraw: { // 抽獎後的 drawList，不會影響 drawList。
                        win: { // 被抽中的名單
                            data: [],
                            text: '',
                        },  // 沒抽中的名單
                        lose: {
                            data: [],
                            text: '',
                        },
                        outputText: localStorage.getItem('lotteryResultData') || '',
                    },
                })

                function loadLS(){
                    try {
                        let obj_LS = JSON.parse( data_LS.value );
                        for (let [key, val] of Object.entries( obj_LS ) ){
                            data[key] = val;
                        }
                    } catch (err){
                        let yes = confirm('讀取失效。是否清除暫存紀錄?');
                        if ( yes ){
                            localStorage.removeItem('lotteryData');
                        }
                    }
                }
                
                const prizes_amount = computed(()=>{
                    return data.prizes.data.reduce((acc,val,idx)=> +acc + +val.amount, 0);
                })

                watch( ()=>{ 
                    return data.prizes.text
                }, (newVal, oldVal)=>{
                    
                })

                function prizes_reverse(){
                    data.prizes.text = data.prizes.text.split('\n').reverse().join('\n');
                    data.prizes.data = updatePrizes_text2data();
                }
                function updatePrizes_data2text(){
                    let txt = '';
                    for ( let i=0; i<data.prizes.data.length; i++ ){
                        let e = data.prizes.data[i];
                        txt += `${e.name},${e.amount}`;
                        if ( i != data.prizes.data.length - 1 ){
                            txt += '\n';
                        }
                    }
                    return txt;
                }
                function updatePrizes_text2data(){
                    let arr = data.prizes.text.split('\n');
                    let map = arr.map((e,idx)=>{
                        let name = e.split(',')[0] || '';
                        let amount = +e.split(',')[1] || 1;
                        return { name, amount, winners: [] };
                    })
                    return map;
                }
                function updateDrawList_data2text( obj ){
                    let txt = '';
                    for ( let i=0; i<obj.data.length; i++ ){
                        txt += obj.data[i];
                        if ( i != obj.data.length - 1 ){
                            txt += '\n';
                        }
                    }
                    return txt;
                }
                function updateDrawList_text2data( obj ){
                    let arr = obj.text.split('\n');
                    return arr;
                }

                function genPrizes(len){
                    let arr = Array.from({length: len}, (e,i)=> { return {name: `${i+1}等獎`, amount: (i+1)*(i+1), winners: []} });
                    data.prizes.data = arr;
                    data.prizes.text = updatePrizes_data2text();
                }
                function genDrawList(len){
                    let arr = Array.from({length: len}, (e,i)=> '編號' + (i+1));
                    let txt = String(arr).split(',').join('\n');
                    data.drawList.data = arr;
                    data.drawList.text = txt;
                }
                function fileOnChange(){
                    const selectedFile = $('#fileInput')[0].files[0];
                    if (selectedFile) {
                        const reader = new FileReader();
                        data.bannerSize = +(selectedFile.size / 1024 / 1024).toFixed(3);
                        reader.onload = function(e) {
                            data.banner = e.target.result;
                        };
                        reader.readAsDataURL(selectedFile);
                    } else {
                        data.banner = '';
                        data.bannerSize = 0;
                    }
                }
                function saveToLS(){
                    try {
                        let LS_str = JSON.stringify( Vue.toRaw(data) );
                        localStorage.setItem("lotteryData", LS_str);
                        data_LS.value = LS_str;
                        alert('已暫存!');
                    } catch (err){
                        alert('暫存失敗，數據過大無法暫存。');
                    }
                    if ( localStorage.getItem("lotteryData") ){
                    }
                }
                function readyToDraw(){
                    let prizeErr = data.prizes.data.some((e)=>e.name === '');
                    let listErr = data.drawList.data.some((e)=> e === '');
                    if ( listErr || prizeErr ){
                        if ( prizeErr ){ alert('獎項設定有空白'); }
                        if ( listErr ){ alert('待抽名單有空白'); }
                    } else {
                        dataReady.value = true;
                        for ( let obj of data.prizes.data ){
                            obj.winners = [];
                        }
                        $('#offcanvas-settings').offcanvas('hide');
                    }
                }

                function toEditMode(){
                    dataReady.value = false;
                    isDraw.value = false;
                }
                
                function remove_outputText(){
                    localStorage.removeItem("lotteryResultData");
                    data.drawListDraw.outputText = "";
                }

                async function startDraw(){
                    isDraw.value = true;
                    data.drawListDraw.outputText = '';
                    let drawList = Vue.toRaw(data.drawList);

                    let sortList = JSON.parse(JSON.stringify(drawList));
                        sortList.data.sort(() => Math.random() - 0.5);

                    let winListData = sortList.data.slice(0, prizes_amount.value); // 取陣列前 prizes_amount 抽數 (抽中的)。

                    let startIdx = 0;
                    let outputTxt = '';
                    for ( let obj of data.prizes.data ){
                        await resolveAfter2Seconds(1000);
                        let amount = +obj.amount;
                        let endIdx = startIdx + amount;
                        obj.winners = winListData.slice(startIdx, endIdx);

                        outputTxt += `=== ${obj.name} (抽出:${obj.amount}個) (得獎:${obj.winners.length}人) ===\n`
                        outputTxt += obj.winners.join('\n') + '\n';
                        startIdx = endIdx;
                    }

                    function resolveAfter2Seconds(s) {
                        return new Promise((resolve) => {
                            setTimeout(() => {
                                resolve();
                            }, s || 10);
                        });
                    }

                    let loseListData = drawList.data.filter((e)=>{
                        return winListData.indexOf(e) === -1;
                    })

                    // data.drawListDraw.win.data = winListData;
                    // data.drawListDraw.win.text = updateDrawList_data2text( data.drawListDraw.win );

                    data.drawListDraw.lose.data = loseListData;
                    data.drawListDraw.lose.text = updateDrawList_data2text( data.drawListDraw.lose );

                    data.drawListDraw.outputText = outputTxt;
                    localStorage.setItem("lotteryResultData", outputTxt);
                }

                return {
                    data,
                    data_LS,
                    dataReady,
                    isDraw,
                    prizes_amount,
                    genDrawListValue,
                    updatePrizes_text2data,
                    updateDrawList_text2data,
                    prizes_reverse,
                    genDrawList,
                    genPrizes,
                    remove_outputText,
                    fileOnChange,
                    toEditMode,
                    loadLS,
                    saveToLS,
                    readyToDraw,
                    startDraw,
                }
            }
        }).mount('#wrap');
        

        $('#offcanvas-settings').on('show.bs.offcanvas', (evt) => {
            $('#main').addClass('isOpen');
        })
        $('#offcanvas-settings').on('hide.bs.offcanvas', (evt) => {
            $('#main').removeClass('isOpen');
        })
    </script>
</body>
</html>